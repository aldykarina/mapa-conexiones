<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa de Conexiones</title>
  <style>
    :root{--sidebar:320px;--gap:12px;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    html,body{height:100%;margin:0}
    .app{display:flex;height:100vh;gap:var(--gap)}
    .sidebar{width:var(--sidebar);padding:16px;background:#f8f8f9;border-right:1px solid #e0e0e0;box-sizing:border-box;overflow:auto}
    .sidebar h2{margin:0 0 12px 0;font-size:18px}
    .controls{display:flex;gap:8px;flex-direction:column}
    .person-list{margin-top:8px;max-height:60vh;overflow:auto;border:1px solid #eee;padding:8px;border-radius:6px;background:#fff}
    .person-item{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px}
    .person-item img{width:36px;height:36px;border-radius:50%;object-fit:cover}
    .main{flex:1;display:flex;flex-direction:column}
    #cy{flex:1;border-left:1px solid #eaeaea}
    .topbar{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid #eee;background:#fff}
    button{padding:8px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
    input[type="text"]{padding:8px;border-radius:8px;border:1px solid #ccc;width:100%}
    .small{font-size:13px;color:#555}
    .hint{font-size:12px;color:#777;margin-top:8px}
  </style>

  <!-- Cytoscape base -->
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <h2>Mapa de Conexiones</h2>
      <div class="controls">
        <label class="small">Soy:</label>
        <input id="currentPersonInput" type="text" placeholder="Escribe tu nombre..." />
        <select id="currentPerson" size="5" style="margin-top:4px;"></select>

        <label class="small">Busca persona:</label>
        <input id="searchPerson" type="text" placeholder="nombre o apellido" />

        <div style="margin-top:8px">
          <div class="small">Marcar a quienes conoces:</div>
          <div id="personList" class="person-list"></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="btnSave">Guardar conexiones</button>
          <button id="btnClear">Borrar datos</button>
        </div>

        <div style="margin-top:12px">
          <button id="btnExport">Exportar PNG</button>
        </div>

        <p class="small hint">Nota: Los cambios se guardan en <code>localStorage</code>. El gráfico se puede exportar como imagen.</p>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="small">Visualización: nodos = personas, líneas = conocimiento</div>
      </div>
      <div id="cy"></div>
    </main>
  </div>

  <script>
  const PEOPLE_JSON = './people_example20.json';
  const LS_KEY = 'mapaConexiones_v1';

  let state = { people: [], connections: {} };

  // Helpers de storage
  function saveAll(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)) }
  function loadAll(){ const s = localStorage.getItem(LS_KEY); return s ? JSON.parse(s) : null }

  // Inicializar Cytoscape
  const cy = cytoscape({
    container: document.getElementById('cy'),
    elements: [],
    style: [
      { selector: 'node', style: {
        'label': 'data(label)',
        'text-valign': 'bottom',
        'text-margin-y': 4,
        'background-fit': 'cover',
        'background-image': 'data(img)', 
        'border-color':'#ffffff',
        'border-width':2,
        'width': 50,
        'height':50,
        'font-size':10
      }},
      { selector: 'edge', style: {
        'width': 2, 'line-color': '#FF0000' // ahora rojo
      }},
    ],
    layout: { name: 'cose', animate: true }
  });

  // Cargar personas
  async function fetchPeople(){
    const res = await fetch(PEOPLE_JSON);
    const js = await res.json();
    return js.map((p,i)=>({
      id: p.id?.toString() || 'p'+(i+1),
      name: p.name || p.nombre || '',
      last: p.last || p.lastName || '',
      img: p.img || p.image || '',
      description: p.description || ''
    }));
  }

  function buildElements(){
    const nodes = state.people.map(p=>({ data: { id: p.id, label: p.name+' '+(p.last||''), img: p.img }}));
    const edges = [];
    for(const from in state.connections){
      for(const to in state.connections[from]){
        edges.push({ data: { id: from+'_'+to, source: from, target: to }});
      }
    }
    return {nodes, edges};
  }

  function refreshGraph(){
    const elems = buildElements();
    cy.elements().remove();
    cy.add(elems.nodes);
    cy.add(elems.edges);
    cy.layout({ name:'cose', animate:true }).run();
  }

  // UI
  const sel = document.getElementById('currentPerson');
  const input = document.getElementById('currentPersonInput');
  const list = document.getElementById('personList');
  const search = document.getElementById('searchPerson');

  function populateSelect(filter=''){
    sel.innerHTML = '';
    state.people
      .filter(p=>(p.name+' '+(p.last||'')).toLowerCase().includes(filter.toLowerCase()))
      .forEach(p=>{
        const opt=document.createElement('option');
        opt.value=p.id; opt.textContent=p.name+' '+(p.last||'');
        sel.appendChild(opt);
      });
  }

  function renderPersonList(filter=''){
    list.innerHTML='';
    const me = sel.value;
    const conns = state.connections[me]||{};
    state.people.filter(p=>(p.name+' '+(p.last||'')).toLowerCase().includes(filter.toLowerCase()))
      .forEach(p=>{
        if(p.id===me) return;
        const item=document.createElement('div'); item.className='person-item';
        const img=document.createElement('img'); img.src=p.img;
        const label=document.createElement('div'); label.textContent=p.name+' '+(p.last||''); label.style.flex='1';
        const chk=document.createElement('input'); chk.type='checkbox'; chk.dataset.id=p.id; chk.checked=!!conns[p.id];
        item.appendChild(img); item.appendChild(label); item.appendChild(chk);
        list.appendChild(item);
      });
  }

  // Eventos
  input.addEventListener('input',()=>populateSelect(input.value));
  sel.addEventListener('change',()=>renderPersonList(search.value));
  search.addEventListener('input',()=>renderPersonList(search.value));

  document.getElementById('btnSave').addEventListener('click',()=>{
    const me=sel.value; if(!me) return;
    const checks=Array.from(list.querySelectorAll('input[type=checkbox]'));
    state.connections[me]={};
    checks.forEach(c=>{if(c.checked) state.connections[me][c.dataset.id]=true});
    saveAll(state); refreshGraph();
    alert('Conexiones guardadas');
  });

  document.getElementById('btnClear').addEventListener('click',()=>{
    if(!confirm('Borrar todo?')) return;
    localStorage.removeItem(LS_KEY);
    state.connections={}; refreshGraph(); renderPersonList();
  });

  document.getElementById('btnExport').addEventListener('click',()=>{
    const png=cy.png({full:true,scale:2});
    const a=document.createElement('a'); a.href=png; a.download='mapa-conexiones.png'; a.click();
  });

  // Init
  (async function init(){
    const persisted=loadAll();
    const remote=await fetchPeople();
    state.people=remote;
    state.connections=persisted?.connections||{};
    populateSelect();
    renderPersonList();
    refreshGraph();
  })();
  </script>
</body>
</html>
